{% extends 'base.html' %}
{% load static %}
{% block content %}
    {% load filters %}

    <link rel="stylesheet" href="{% static 'static/css/my_projects.css' %}">
    <section class="bg-white mx-1">
        <div>
            <div>
  </div>

<div class="offcanvas-collapse" id="offcanvasRight">
    <div class="offcanvas-header">
        <h5 class="bg-secondary" style="padding: 7%">Kerakli menyularni tanlang</h5>
        <button type="button" class="close_canvas btn btn-danger float-right mb-2 mr-4">
            &times;
        </button>
    </div>
    <div class="offcanvas-body">
<table class="table table-responsive table-bordered">
    <thead>
        <tr>
            <th scope="col" class="col-lg-6 col-md-6 col-sm-12">Filter</th>
            <th scope="col" class="col-lg-6 col-md-6 col-sm-12"></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <label>
                    <input class="cols" name="project_name" type="checkbox"> Loyiha nomi
                </label><br>
                <label>
                    <input class="cols" name="project_description" type="checkbox"> Loyiha haqida
                </label><br>
                <label>
                    <input class="cols" name="project_blog" type="checkbox"> Blok
                </label><br>
                <label>
                    <input class="cols" name="project_type" type="checkbox"> Loyiha turi
                </label><br>
                <label>
                    <input class="cols" name="project_size" type="checkbox"> Masshtab
                </label><br>
                <label>
                    <input class="cols" name="project_level" type="checkbox"> Muhimlilik darajasi
                </label><br>
                <label>
                    <input class="cols" name="project_speed" type="checkbox"> Muddat darajasi
                </label><br>
            </td>
            <td>
                <label>
                    <input class="cols" name="project_departments" type="checkbox"> Mas'ul departament(lar)
                </label><br>
                <label>
                    <input class="cols" name="project_team" type="checkbox"> Mas'ul xodim(lar)
                </label><br>
                <label>
                    <input class="cols" name="project_budget" type="checkbox"> Umumiy loyiha summasi
                </label><br>
                <label>
                    <input class="cols" name="project_deadline" type="checkbox"> Taxminiy yakunlash sanasi
                </label><br>
                <label>
                    <input class="cols" name="project_status" type="checkbox"> Loyiha statusi
                </label><br>
                <label>
                    <input class="cols" name="project_curator" type="checkbox"> Strategiya departamentida biriktirilgan xodim
                </label><br>
                <label>
                    <input class="cols" name="project_spent_money" type="checkbox"> Sarflangan xarajat
                </label>
            </td>
        </tr>
    </tbody>
</table>


        <button id="apply-changes" class="btn btn-primary w-100">Qo'llash</button>
    </div>
</div>
                    <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title d-inline">Barcha loyihalar</h3>

                <div class="card-tools" style="margin-right: 0.02%;width: 32.5%">
                  <div class="input-group input-group-sm" style="width: 99.2%;">
                    <input type="text" id="search-project" name="table_search" class="form-control float-right search-projects" placeholder="Qidirish">
                            <select class="custom-select input-sm" id="filter-all-projects">
        <option value="all" selected>Barchasi</option>
        <option value="Yangi">Boshlanmagan</option>
        <option value="Jarayonda">Jarayonda</option>
        <option value="Tugatilgan">Tugatilgan</option>
        <option value="least7">7 kun qolgan</option>
        <option value="least30">1 oy qolgan</option>
        <option value="least90">3 oy qolgan</option>
      </select>
                      <button style="rotate: 90deg" id="filter-table" class="fa-solid fa-sliders btn-sm border border-dark" data-toggle="offcanvas" data-target="#offcanvasRight"></button>
                  </div>
                </div>
              </div>
                <div class="table-responsive card-body p-0">
                <table id="table-projects" class="table table-striped table-bordered projects-table projects" style="margin-top: -0.1%">
                  <thead>
                    <tr>
                      <th scope="col" class="col-0">â„–</th>
                      <th scope="col" class="col-2">Loyiha nomi</th>
                      <th scope="col" class="col-3">Loyiha haqida</th>
                      <th scope="col" class="col-3">Departamentlar</th>
                      <th scope="col" class="col-1">Summasi</th>
                      <th scope="col" class="col-2">Hodim</th>
                      <th scope="col" class="col-3">Holati</th>
                    </tr>
                  </thead>
                    <tbody id="projects-body">
                    {% for project in projects %}
                        <tr class="datas" data-url="{% url 'get-project' project.pk %}">
                            <td>
                                {{ forloop.counter }}
                            </td>
                            <td id="project-name">
                                <a href="{% url 'get-project' project.pk %}" style="color: black">
                                    {{ project.project_name }}
                                </a>
                            </td>
                            <td>
                                                           <a href="{% url 'get-project' project.pk %}"
                                                              style="color: black"> {{ project.project_description }} </a>
                            </td>
                            <td >
                                                        <a href="{% url 'get-project' project.pk %}"
                                       style="color: black">
                                {% for department in project.project_departments.all %}
                                    {{ department.department_name}},
                                {% endfor %}</a>
                            </td>

                                                                                                         <td class="project-state">
                                <p>                             <a href="{% url 'get-project' project.pk %}"
                                                                   style="color: black">{{ project.project_budget | format_number}} </a></p>
                            </td>

                                                                                                                            <td class="text-start">
                                                                                                                                <a href="{% url 'my-projects-detail' project.pk %}"
                                                                  style="color: black">{{ project.project_curator.get_full_name}} </a>
                            </td>
                                                        <td class="project_progress" style="width: 10%;">
                                <div class="progress progress-sm">
                                    <div class="progress-bar {% if project.project_status == 'Yangi' %} bg-light {% elif project.project_status == 'Jarayonda' %} bg-yellow {% elif project.project_status == 'Tugatilgan' %}bg-green{% endif %}"
                                         role="progressbar" aria-valuenow="{{ project.project_done_percentage }}"
                                         aria-valuemin="0" aria-valuemax="100"
                                         style="width: {{ project.project_done_percentage }}%">
                                    </div>
                                </div>
                                <p>
                                    {{ project.project_done_percentage }}%<br>
                                    <p class="badge {% if project.project_status == 'Yangi' %}badge-info{% elif project.project_status == 'Jarayonda'  %}badge-warning {% else %}badge-success{% endif %}">{{ project.project_status }}</p>
                                </p>

                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                </div>
        <div class="card-footer clearfix">
    <ul class="pagination pagination-sm m-0 float-right">
        {% if projects.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ projects.previous_page_number }}">&laquo; Oldingi</a>
            </li>
            {% if projects.number > 3 %}
                <li class="page-item"><a class="page-link" href="?page=1">1</a></li>
                {% if projects.number > 4 %}
                    <li class="page-item"><span class="page-link">...</span></li>
                {% endif %}
            {% endif %}
        {% endif %}

        {% for num in projects.paginator.page_range %}
            {% if projects.number == num %}
                <li class="page-item active">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
            {% elif num > projects.number|add:'-3' and num < projects.number|add:'7' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if projects.has_next %}
            {% if projects.number < projects.paginator.num_pages|add:'-3' %}
                <li class="page-item"><span class="page-link">...</span></li>
                <li class="page-item"><a class="page-link" href="?page={{ projects.paginator.num_pages }}">{{ projects.paginator.num_pages }}</a></li>
            {% elif projects.number < projects.paginator.num_pages|add:'-6' %}
                <li class="page-item"><a class="page-link" href="?page={{ projects.paginator.num_pages }}">{{ projects.paginator.num_pages }}</a></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link" href="?page={{ projects.next_page_number }}">Keyingi &raquo;</a>
            </li>
        {% endif %}
    </ul>
</div>

            </div>
          </div>
                    </div>
            </div>
    </section>
    <script type="text/javascript">
        var projects_s = {{ projects_serialized | safe }};
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
        var toggleButton = document.querySelector('[data-toggle="offcanvas"]');
        var offcanvasElement = document.querySelector(toggleButton.getAttribute('data-target'));
        var closeButton = offcanvasElement.querySelector('.close_canvas');

toggleButton.addEventListener('click', function (event) {
    console.log('clicked');
    offcanvasElement.classList.add('show');
    event.stopPropagation();
    setTimeout(() => {
        document.addEventListener('click', function (e) {
            let canvas = document.getElementById('offcanvasRight');
            if (!canvas.contains(e.target)) {
                offcanvasElement.classList.remove('show');
            }
        }, { once: true });
    }, 0);
});


        closeButton.addEventListener('click', function () {
            offcanvasElement.classList.remove('show');
        });
        var cols = []
        var colNames = []
        var thead = ''
        var tbody = ''
        filters = document.querySelectorAll('.cols');
        filters.forEach(value => {
            value.addEventListener('change', function (e) {
                var checked = e.target.checked
                if (checked) {
                    console.log(value.parentNode.textContent.trim())
                    cols.push(value.parentNode.textContent.trim())
                    colNames.push(value.name)
                } else {
                    cols = cols.filter(item => item !== value.parentNode.textContent.trim());
                    colNames = colNames.filter(item => item !== value.name);
                }
            })
        })

        document.getElementById('apply-changes').addEventListener('click', function () {
             offcanvasElement.classList.remove('show');
            thead = ''
            tbody = ''
            cols.forEach(col => {
                thead += `<th>${col}</th>`

            })
            for (i = 0; i < projects_s.length; i++) {
                var tds = ''
                colNames.forEach(value => {
                    tds += `<td><a href=${window.location.pathname.replace('all',projects_s[i].pk)} style="color:#000;">${projects_s[i].fields[value]}</a></td>`
                })
                tbody += `<tr>${tds}</tr>`
            }
            document.getElementById('table-projects').innerHTML = `<thead><tr>${thead}</tr></thead><tbody>${tbody}</tbody>`
        })
    });
    </script>
<script src="{% static 'static/js/expense.js' %}"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
    var projects_serialized = {{ all_serialized | safe }}
    </script>
{% endblock content %}
